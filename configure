#! /usr/bin/python3

import argparse
import os

parser = argparse.ArgumentParser()
debugging_group = parser.add_mutually_exclusive_group()
debugging_group.add_argument("--enable-debugging", action="store_true", default=None, dest="debugging")
debugging_group.add_argument("--disable-debugging", action="store_false", default=None, dest="debugging")
optimization_group = parser.add_mutually_exclusive_group()
optimization_group.add_argument("--enable-optimization", action="store_true", default=None, dest="optimization")
optimization_group.add_argument("--disable-optimization", action="store_false", default=None, dest="optimization")
arguments = parser.parse_args()

write_all = False

def get_line_parts(line, name):
	prefix = name + " = "
	if line.startswith(prefix) == True:
		return set(line[len(prefix):].split())
	else:
		return set()

configuration_directory = ".configuration.d"
if os.path.isdir(configuration_directory) == False:
	if os.path.exists(configuration_directory) == True:
		os.remove(configuration_directory)
	os.makedirs(configuration_directory)
	write_all = True

if os.path.exists("configuration") == False or os.path.getctime("configure") > os.path.getctime("configuration"):
	write_all = True

configuration_CXXFLAGS = set()
configuration_LDFLAGS = set()
for item_name in os.listdir(configuration_directory):
	item_path = os.path.join(configuration_directory, item_name)
	if os.path.isfile(item_path) == True:
		for line in open(item_path):
			configuration_CXXFLAGS |= get_line_parts(line, "CXXFLAGS")
			configuration_LDFLAGS |= get_line_parts(line, "LDFLAGS")

CXXFLAGS = configuration_CXXFLAGS.copy()
CXXFLAGS.add("-Wall")
CXXFLAGS.add("-Werror")
CXXFLAGS.add("-std=c++11")
LDFLAGS = configuration_LDFLAGS.copy()

if arguments.debugging == True:
	CXXFLAGS.add("-g")
	LDFLAGS.add("-g")
elif arguments.debugging == False:
	CXXFLAGS.discard("-g")
	LDFLAGS.discard("-g")

if arguments.optimization == True:
	CXXFLAGS.add("-O2")
elif arguments.optimization == False:
	CXXFLAGS.discard("-O2")

if len(CXXFLAGS.symmetric_difference(configuration_CXXFLAGS)) > 0 or write_all == True:
	print("Configuring CXXFLAGS=" + " ".join(CXXFLAGS))
	with open(os.path.join(configuration_directory, "CXXFLAGS"), "w") as file:
		file.write("# configuration generated by configure and read by Makefiles\n")
		file.write("CXXFLAGS_configuration = $(root)/.configuration.d/CXXFLAGS\n")
		file.write("CXXFLAGS = " + " ".join(CXXFLAGS) + "\n")
else:
	print("Configuration CXXFLAGS=" + " ".join(CXXFLAGS))

if len(LDFLAGS.symmetric_difference(configuration_LDFLAGS)) > 0 or write_all == True:
	print("Configuring LDFLAGS=" + " ".join(LDFLAGS))
	with open(os.path.join(configuration_directory, "LDFLAGS"), "w") as file:
		file.write("# configuration generated by configure and read by Makefiles\n")
		file.write("LDFLAGS_configuration = $(root)/.configuration.d/LDFLAGS\n")
		file.write("LDFLAGS = " + " ".join(LDFLAGS) + "\n")
else:
	print("Configuration LDFLAGS=" + " ".join(LDFLAGS))

with open("configuration", "w") as file:
	file.write("# configuration generated by configure and read by Makefiles\n\n")
	file.write("include ${root}/.configuration.d/CXXFLAGS\n\n")
	file.write("include ${root}/.configuration.d/LDFLAGS\n")
