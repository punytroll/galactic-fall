#! /bin/bash

configure_CXXFLAGS=""
configure_LDFLAGS=""

# if --help command line argument is given, display which variables may be set with this configuration file
if [ "$1" = "--help" ]; then
	echo "CXXFLAGS = "
	echo "LDFLAGS = "
	exit 1
fi

# if no arguments are given, cat the configuration file and exit
if [ $# -eq 0 -a -e configuration ]; then
	cat configuration
	exit 0
fi

# this function unifies the string sets $1 and $2 without repetition and puts the result in $result
function unify
{
	local IFS=" "
	result=$1
	for word in $2; do
		for test_word in $1; do
			if [ "${word}" = "${test_word}" ]; then
				continue 2
			fi
		done
		result="${result} ${word}"
	done
}

# this function removes all strings in the string set $2 from the string set $1 and puts the result in $result
function subtract
{
	local IFS=" "
	result=""
	for word in $1; do
		echo $word
		for test_word in $2; do
			if [ "${word}" = "${test_word}" ]; then
				continue 2
			fi
		done
		result="${result} ${word}"
	done
}

# read the "configuration" file and initialize variables with the values from that file
if [ -e configuration ]; then
	configuration=`cat configuration`
	IFS='
'
	for configuration_line in ${configuration}; do
		if [ -n "${configuration_line}" ]; then
			case ${configuration_line} in
			"CXXFLAGS = "*)
				configure_CXXFLAGS=`echo ${configuration_line} | sed -e 's/^CXXFLAGS = //'`
				;;
			"LDFLAGS = "*)
				configure_LDFLAGS=`echo ${configuration_line} | sed -e 's/^LDFLAGS = //'`
				;;
			esac
		fi
	done
fi

# process the options from the command line
for option in "$@"; do
	case ${option} in
	CXXFLAGS=*)
		configure_CXXFLAGS=`echo ${option} | sed -e 's/^CXXFLAGS=//'`
		;;
	CXXFLAGS+=*)
		add_CXXFLAGS=`echo ${option} | sed -e 's/^CXXFLAGS+=//'`
		unify ${configure_CXXFLAGS} ${add_CXXFLAGS}
		configure_CXXFLAGS=${result}
		;;
	CXXFLAGS-=*)
		subtract_CXXFLAGS=`echo ${option} | sed -e 's/^CXXFLAGS-=//'`
		subtract ${configure_CXXFLAGS} ${subtract_CXXFLAGS}
		configure_CXXFLAGS=${result}
		;;
	LDFLAGS=*)
		configure_LDFLAGS=`echo ${option} | sed -e 's/^LDFLAGS=//'`
		;;
	LDFLAGS+=*)
		add_LDFLAGS=`echo ${option} | sed -e 's/^LDFLAGS+=//'`
		unify ${configure_LDFLAGS} ${add_LDFLAGS}
		configure_LDFLAGS=${result}
		;;
	LDFLAGS-=*)
		subtract_LDFLAGS=`echo ${option} | sed -e 's/^LDFLAGS-=//'`
		subtract ${configure_CLDFLAGS} ${subtract_LDFLAGS}
		configure_LDFLAGS=${result}
		;;
	esac
done

# write the configuration file
echo "# configuration generated by configure and read by Makefile." > configuration
echo >> configuration
echo "CXXFLAGS = ${configure_CXXFLAGS}" >> configuration
echo >> configuration
echo "LDFLAGS = ${configure_LDFLAGS}" >> configuration
echo >> configuration
